<?php
/*
Plugin Name: Add Destination Role and Redirect
Description: Adds custom user roles called "Destination" and "Travel Manager" and redirects users with these roles to specific customizable posts upon login. Adds custom dashboard widgets with the link and title of the assigned private pages.
Version: 1.9
Author: Your Name
*/

// Function to add the 'destination' role
function add_destination_role() {
	add_role(
		'destination',
		'Destination',
		array(
			'read'                     => true,
			'edit_posts'               => false,
			'delete_posts'             => false,
			'read_private_posts'       => true, // Capability to read private posts
		)
	);
}

function add_travel_manager_role() {
	add_role(
		'travel_manager',
		'Travel Manager',
		array(
			'read'                               => true,
			'edit_posts'                         => true,
			'delete_posts'                       => true,
			'publish_posts'                      => true,
			'edit_published_posts'               => true,
			'edit_others_posts'                  => true,
			'delete_published_posts'             => true,
			'delete_others_posts'                => true,
			'read_private_posts'                 => true,
			'edit_pages'                         => true,
			'edit_others_pages'                  => true,
			'edit_published_pages'               => true,
			'publish_pages'                      => true,
			'delete_pages'                       => true,
			'delete_others_pages'                => true,
			'delete_published_pages'             => true,
			'read_private_pages'                 => true,
			'gravityforms_edit_forms'            => true,
			'gravityforms_delete_forms'          => true,
			'gravityforms_create_form'           => true,
			'gravityforms_view_entries'          => true,
			'gravityforms_edit_entries'          => true,
			'gravityforms_delete_entries'        => true,
			'gravityforms_view_settings'         => true,
			'gravityforms_edit_settings'         => true,
			'gravityforms_export_entries'        => true,
			'gravityforms_view_entry_notes'      => true,
			'gravityforms_edit_entry_notes'      => true
		)
	);
}
add_action('init', 'add_travel_manager_role');

function add_tfs_staff_role() {
	add_role(
		'tfs_staff',
		'TFS Staff',
		array(
			'read'                               => true,
			'edit_posts'                         => false,
			'delete_posts'                       => false,
			'publish_posts'                      => false,
			'edit_published_posts'               => false,
			'edit_others_posts'                  => false,
			'delete_published_posts'             => false,
			'delete_others_posts'                => false,
			'read_private_posts'                 => true,
			'edit_pages'                         => false,
			'edit_others_pages'                  => false,
			'edit_published_pages'               => false,
			'publish_pages'                      => false,
			'delete_pages'                       => false,
			'delete_others_pages'                => false,
			'delete_published_pages'             => false,
			'read_private_pages'                 => true,
			'gravityforms_edit_forms'            => false,
			'gravityforms_delete_forms'          => false,
			'gravityforms_create_form'           => false,
			'gravityforms_view_entries'          => false,
			'gravityforms_edit_entries'          => false,
			'gravityforms_delete_entries'        => false,
			'gravityforms_view_settings'         => false,
			'gravityforms_edit_settings'         => false,
			'gravityforms_export_entries'        => false,
			'gravityforms_view_entry_notes'      => false,
			'gravityforms_edit_entry_notes'      => false
		)
	);
}
add_action('init', 'add_tfs_staff_role');

function add_gravity_forms_caps_to_admin() {
	// Adding necessary capabilities to the 'travel_manager' role
	$role = get_role('travel_manager');
	
	if ($role) {
		$caps = array(
			'gravityforms_edit_forms',
			'gravityforms_delete_forms',
			'gravityforms_create_form',
			'gravityforms_view_entries',
			'gravityforms_edit_entries',
			'gravityforms_delete_entries',
			'gravityforms_view_settings',
			'gravityforms_edit_settings',
			'gravityforms_export_entries',
			'gravityforms_view_entry_notes',
			'gravityforms_edit_entry_notes'
		);
		
		foreach ($caps as $cap) {
			$role->add_cap($cap);
		}
	}
}
add_action('admin_init', 'add_gravity_forms_caps_to_admin');

// Function to add roles upon plugin activation
function add_roles_on_activation() {
	add_destination_role();
	add_travel_manager_role();
	add_tfs_staff_role();
}

register_activation_hook(__FILE__, 'add_roles_on_activation');

// Function to remove roles upon plugin deactivation
function remove_roles_on_deactivation() {
	remove_role('destination');
	remove_role('travel_manager');
	add_tfs_staff_role();
}

register_deactivation_hook(__FILE__, 'remove_roles_on_deactivation');

// Grant the 'destination' role access to private travel forms and specific private pages
function grant_destination_role_private_access() {
	$role = get_role('destination');
	if ($role) {
		$role->add_cap('read_private_posts');
	}
}
add_action('init', 'grant_destination_role_private_access');

// Add custom user meta fields to the user profile pages
function add_custom_user_meta_field($user) {
	if (in_array('destination', (array) $user->roles) || in_array('travel_manager', (array) $user->roles) || in_array('tfs_staff', (array) $user->roles)) { ?>
      <h3><?php _e('Custom Redirect URL', 'custom-user-meta'); ?></h3>
      <table class="form-table">
          <tr>
              <th><label for="custom_redirect_url"><?php _e('Redirect URL'); ?></label></th>
              <td>
                  <input type="text" name="custom_redirect_url" id="custom_redirect_url" value="<?php echo esc_attr(get_user_meta($user->ID, 'custom_redirect_url', true)); ?>" class="regular-text" /><br />
                  <span class="description"><?php _e('Enter the URL to which you want to redirect this user upon login.'); ?></span>
              </td>
          </tr>
      </table>
	<?php }
}

add_action('show_user_profile', 'add_custom_user_meta_field');
add_action('edit_user_profile', 'add_custom_user_meta_field');

// Save the custom user meta field value
function save_custom_user_meta_field($user_id) {
	if (!current_user_can('edit_user', $user_id)) return false;
	update_user_meta($user_id, 'custom_redirect_url', $_POST['custom_redirect_url']);
}

add_action('personal_options_update', 'save_custom_user_meta_field');
add_action('edit_user_profile_update', 'save_custom_user_meta_field');

// Redirect 'destination' and 'travel_manager' users to specific pages upon login based on the user meta field
function redirect_custom_user_on_login($redirect_to, $request, $user) {
	if (isset($user->roles) && is_array($user->roles)) {
		if (in_array('destination', $user->roles) || in_array('travel_manager', $user->roles) || in_array('tfs_staff', $user->roles)) {
			$custom_redirect_url = get_user_meta($user->ID, 'custom_redirect_url', true);
			if ($custom_redirect_url) {
				return $custom_redirect_url;
			}
		}
	}
	return $redirect_to;
}

add_filter('login_redirect', 'redirect_custom_user_on_login', 10, 3);

// Add a custom dashboard widget for 'destination' users
function add_destination_dashboard_widget() {
	if (current_user_can('destination')) {
		wp_add_dashboard_widget(
			'destination_dashboard_widget',
			'Your Private Page',
			'display_destination_dashboard_widget_content'
		);
	}
}
add_action('wp_dashboard_setup', 'add_destination_dashboard_widget');

// Display content of the custom dashboard widget for 'destination' users
function display_destination_dashboard_widget_content() {
	$user_id = get_current_user_id();
	$custom_redirect_url = get_user_meta($user_id, 'custom_redirect_url', true);
	
	if ($custom_redirect_url) {
		$page_id = url_to_postid($custom_redirect_url);
		$page_title = get_the_title($page_id);
		echo '<p>You have access to the following private page:</p>';
		echo '<p><strong>Title:</strong> ' . esc_html($page_title) . '</p>';
		echo '<p><strong>Link:</strong> <a href="' . esc_url($custom_redirect_url) . '">' . esc_html($custom_redirect_url) . '</a></p>';
	} else {
		echo '<p>No private page assigned yet.</p>';
	}
}

// Add a custom dashboard widget for 'travel_manager' users
function add_travel_manager_dashboard_widget() {
	if (current_user_can('travel_manager')) {
		wp_add_dashboard_widget(
			'travel_manager_dashboard_widget',
			'Your Private Page',
			'display_travel_manager_dashboard_widget_content'
		);
	}
}
add_action('wp_dashboard_setup', 'add_travel_manager_dashboard_widget');

// Display content of the custom dashboard widget for 'travel_manager' users
function display_travel_manager_dashboard_widget_content() {
	$user_id = get_current_user_id();
	$custom_redirect_url = get_user_meta($user_id, 'custom_redirect_url', true);
	
	if ($custom_redirect_url) {
		$page_id = url_to_postid($custom_redirect_url);
		$page_title = get_the_title($page_id);
		echo '<p>You have access to the following private page:</p>';
		echo '<p><strong>Title:</strong> ' . esc_html($page_title) . '</p>';
		echo '<p><strong>Link:</strong> <a href="' . esc_url($custom_redirect_url) . '">' . esc_html($custom_redirect_url) . '</a></p>';
	} else {
		echo '<p>No private page assigned yet.</p>';
	}
}

// Remove default dashboard widgets for 'destination' role
function remove_default_dashboard_widgets() {
	if (current_user_can('destination')) {
		remove_meta_box('dashboard_activity', 'dashboard', 'normal'); // Activity
		remove_meta_box('dashboard_primary', 'dashboard', 'side'); // WordPress Events and News
	}
}
add_action('wp_dashboard_setup', 'remove_default_dashboard_widgets', 20);

// Remove the toolbar option for 'destination' users
function remove_toolbar_option() {
	// Ensure that administrators and super administrators always see the toolbar
	if (current_user_can('administrator') || current_user_can('super_admin')) {
		return; // Exit the function, hence the toolbar is not hidden
	}
	
	// Hide the toolbar for 'destination' and 'tfs_staff' roles
	if (current_user_can('destination') || current_user_can('tfs_staff')) {
		add_filter('show_admin_bar', '__return_false');
	}
}
add_action('after_setup_theme', 'remove_toolbar_option');

// Redirect specific travel forms to login if the user is not logged in
function redirect_travel_form_to_login_wp_hook() {
	if (!is_user_logged_in() &&
	    (strpos($_SERVER['REQUEST_URI'], '/travel-form/') === 0 || $_SERVER['REQUEST_URI'] === '/travel-form')) {
		// Redirect to the wp-admin login page
		wp_redirect(wp_login_url());
		exit;
	}
}
add_action('template_redirect', 'redirect_travel_form_to_login_wp_hook');